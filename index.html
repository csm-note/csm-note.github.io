<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <title>DB NOTEPAD v5.1 [ULTIMATE]</title>  
    <link rel="manifest" href="manifest.json">  
    <meta name="theme-color" content="#020202">  
    <meta name="apple-mobile-web-app-capable" content="yes">  
  
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">  
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- HTML2PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>  
    :root {  
        --bg-deep: #020202;  
        --bg-panel: #0d0d0d;  
        --bg-hover: #1a1a1a;  
        --neon-main: #0f0;  /* Dynamic Main Color */
        --neon-dim: #004d00; 
        --neon-red: #ff003c;  
        --neon-blue: #00f3ff;  
        --neon-yellow: #fcee0a;
        --border-color: #333;  
        --font-stack: 'Fira Code', monospace;  
        --sidebar-width: 320px;   
    }  

    * { box-sizing: border-box; outline: none; }  
    ::-webkit-scrollbar { width: 5px; height: 5px; }  
    ::-webkit-scrollbar-track { background: var(--bg-deep); }  
    ::-webkit-scrollbar-thumb { background: var(--neon-dim); }  

    /* --- PART 1 FIX: Viewport Height --- */
    body {  
        margin: 0; padding: 0;  
        background-color: var(--bg-deep);  
        color: var(--neon-main);  
        font-family: var(--font-stack);  
        /* Fallback for older browsers */
        height: 100vh; 
        /* Modern mobile fix */
        height: 100dvh; 
        /* Robust JS Fallback implemented in scripts */
        height: calc(var(--vh, 1vh) * 100); 
        overflow: hidden;  
        display: flex; flex-direction: column;  
    }  

    .crt::before {  
        content: " "; display: block; position: absolute;  
        top: 0; left: 0; bottom: 0; right: 0;  
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));  
        z-index: 900; background-size: 100% 2px, 3px 100%; pointer-events: none;  
    }  

    /* --- Auth Screen --- */  
    #auth-layer {  
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;  
        background: var(--bg-deep); z-index: 1000;  
        display: flex; justify-content: center; align-items: center;  
    }  
    .login-box {  
        width: 90%; max-width: 400px; padding: 40px;  
        border: 2px solid var(--neon-main);  
        background: rgba(0, 10, 0, 0.95);  
        box-shadow: 0 0 20px var(--neon-dim);
        text-align: center;  
    }  
    .login-input {  
        width: 100%; padding: 12px; margin: 10px 0;  
        background: black; border: 1px solid var(--neon-dim);  
        color: var(--neon-main); font-family: var(--font-stack);  
    }  
    .login-input:focus { border-color: var(--neon-main); box-shadow: 0 0 5px var(--neon-dim); }

    /* --- App Layout --- */  
    #app-layer { display: none; width: 100%; height: 100%; flex-direction: column; }  
    header {  
        height: 50px; border-bottom: 2px solid var(--border-color);  
        display: flex; justify-content: space-between; align-items: center;  
        padding: 0 20px; background: var(--bg-panel);  
        z-index: 950;
        flex-shrink: 0; /* Prevent header shrinking */
    }  
    .btn {  
        background: transparent; border: 1px solid var(--neon-dim);  
        color: var(--neon-main); padding: 5px 12px; cursor: pointer;  
        font-family: var(--font-stack); font-size: 0.8rem; margin-left: 5px; 
        transition: 0.2s;
    }  
    .btn:hover, .btn:focus { background: var(--neon-main); color: black; box-shadow: 0 0 10px var(--neon-dim); }
    .btn.active { background: var(--neon-main); color: black; }
    
    .btn-danger { color: var(--neon-red); border-color: #500; }
    .btn-danger:hover, .btn-danger:focus { background: var(--neon-red); color: white; box-shadow: 0 0 15px var(--neon-red); }
    
    .btn-info { color: var(--neon-blue); border-color: #004d4d; }
    .btn-info:hover, .btn-info:focus { background: var(--neon-blue); color: black; box-shadow: 0 0 15px var(--neon-blue); }
      
    .workspace { display: flex; flex: 1; overflow: hidden; position: relative; }  
    aside { width: var(--sidebar-width); background: var(--bg-panel); border-right: 2px solid var(--border-color); display: flex; flex-direction: column; z-index: 910; transition: 0.3s;}  
    
    .search-container { padding: 10px; position: relative; border-bottom: 1px solid #111; }
    .search-bar {
        width: 100%; padding: 8px 8px 8px 30px;
        background: black; border: 1px solid var(--border-color);
        color: white; font-family: var(--font-stack);
    }
    .search-icon { position: absolute; left: 20px; top: 20px; color: #555; font-size: 0.8rem; }
    .user-info { padding: 10px 15px; font-size: 0.7rem; color: var(--neon-blue); border-bottom: 1px dashed #222; display: flex; justify-content: space-between; cursor: pointer;}

    .tag-cloud { padding: 10px; border-bottom: 1px solid #222; display: flex; flex-wrap: wrap; gap: 5px; max-height: 80px; overflow-y: auto;}
    .tag-pill { font-size: 0.7rem; background: #111; padding: 2px 6px; border: 1px solid #333; cursor: pointer; color: #888; }
    .tag-pill:hover, .tag-pill.active { border-color: var(--neon-main); color: var(--neon-main); }

    .notes-list { flex: 1; overflow-y: auto; }  
    
    .note-item { padding: 12px 20px; border-bottom: 1px solid #111; cursor: pointer; transition: 0.2s; position: relative; display: flex; justify-content: space-between; align-items: center; }  
    .note-item:hover { background: var(--bg-hover); padding-left: 25px; }  
    .note-item.active { background: rgba(0, 255, 0, 0.05); border-right: 4px solid var(--neon-main); }
    .note-item .pin-icon { opacity: 0; font-size: 0.7rem; color: var(--neon-yellow); }
    .note-item.pinned .pin-icon { opacity: 1; }

    main { flex: 1; display: flex; flex-direction: column; background: var(--bg-deep); position: relative; }  
    
    .editor-toolbar {
        display: flex; align-items: center; border-bottom: 1px dashed #333; padding: 5px 20px;
        background: #050505; flex-shrink: 0;
    }
    #doc-title { flex: 1; padding: 10px; background: transparent; border: none; color: var(--neon-main); font-family: var(--font-stack); font-size: 1.2rem; }  
    
    .split-view { display: flex; flex: 1; overflow: hidden; position: relative; }
    #doc-body { flex: 1; padding: 30px; background: transparent; border: none; color: #ccc; font-family: var(--font-stack); font-size: 1rem; resize: none; line-height: 1.6; z-index: 10; width: 100%; }  
    
    /* Markdown Preview */
    #md-preview { 
        flex: 1; padding: 30px; background: #080808; 
        color: #aaa; overflow-y: auto; 
        border-left: 1px solid #333; 
        display: none; /* Hidden by default */
        font-family: sans-serif;
    }
    #md-preview.active { display: block; }
    #md-preview h1, #md-preview h2 { color: var(--neon-main); border-bottom: 1px solid #333; padding-bottom: 5px; }
    #md-preview code { background: #222; padding: 2px 5px; color: var(--neon-yellow); font-family: var(--font-stack); }
    #md-preview blockquote { border-left: 3px solid var(--neon-blue); margin-left: 0; padding-left: 10px; color: var(--neon-blue); }

    .status-bar { height: 30px; background: var(--bg-panel); border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; font-size: 0.75rem; z-index: 950; flex-shrink: 0;}  

    /* --- Modals --- */
    #modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 3000;
        justify-content: center; align-items: center;
        backdrop-filter: blur(2px);
    }
    .modal-box {
        width: 450px; max-width: 90%; padding: 25px;
        background: #000; border: 2px solid;
        box-shadow: 0 0 30px rgba(0,0,0,0.8);
        text-align: center;
        animation: popIn 0.2s ease-out;
        border-color: var(--neon-main);
        display: flex; flex-direction: column;
    }
    .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; color: var(--neon-main); border-bottom: 1px solid #333; padding-bottom: 10px;}
    .modal-body { text-align: left; max-height: 50vh; overflow-y: auto; margin-bottom: 20px; color: #ccc; font-size: 0.9rem; }
    
    /* Part 4: Shortcut Table Styles */
    .shortcut-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .shortcut-table td { padding: 5px; border-bottom: 1px solid #222; }
    .shortcut-table .key { color: var(--neon-yellow); font-weight: bold; }
    .shortcut-table .desc { color: #aaa; text-align: right; }
    .shortcut-cat { color: var(--neon-blue); padding-top: 10px; font-weight: bold; border:none!important; }

    /* Part 2: Custom Confirm/Prompt Styles */
    .modal-input {
        width: 100%; padding: 10px; background: #111; border: 1px solid #444; color: white;
        font-family: var(--font-stack); margin-top: 10px;
    }
    .modal-input:focus { border-color: var(--neon-main); }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }

    .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .theme-opt { padding: 10px; border: 1px solid #333; cursor: pointer; text-align: center; }
    .theme-opt:hover { border-color: white; }

    /* --- Alerts --- */
    #alert-system { position: fixed; top: 60px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }  
    .terminal-alert { 
        min-width: 300px; padding: 12px 15px; background: rgba(0,0,0,0.9); border-left: 4px solid; 
        font-family: var(--font-stack); font-size: 0.85rem; display: flex; align-items: center; justify-content: space-between;
        box-shadow: 5px 5px 0px rgba(0,0,0,0.5); animation: slideLeft 0.3s ease-out; opacity: 0.9;
    }
    
    .alert-error { border-color: var(--neon-red); color: var(--neon-red); }  
    .alert-success { border-color: var(--neon-main); color: var(--neon-main); }  
    .alert-info { border-color: var(--neon-blue); color: var(--neon-blue); }

    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes slideLeft { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 0.9; } }

    @media (max-width: 768px) {  
        aside { position: absolute; height: 100%; z-index: 100; transform: translateX(-100%); width: 100%; }  
        aside.open { transform: translateX(0); }  
        #menu-btn { display: block !important; }  
        #md-preview.active { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; }
        .modal-box { width: 95%; }
    }  
</style>

</head>  
<body class="crt">  

<!-- AUTH LAYER -->
<div id="auth-layer">  
    <div class="login-box">  
        <h2 style="color: var(--neon-main); margin-bottom:5px;">:: SYSTEM ACCESS ::</h2>  
        <p style="color:#444; font-size:0.7rem; margin-bottom:20px;">SECURE TERMINAL V5.1</p>
        <input type="email" id="email" class="login-input" placeholder="IDENTIFICATION (EMAIL)">  
        <input type="password" id="pass" class="login-input" placeholder="ACCESS KEY (PASSWORD)">  
        <div style="margin-top: 20px; display: flex; gap: 10px;">  
            <button class="btn" onclick="authAction('login')" style="flex:1"><i class="fas fa-unlock"></i> LOGIN</button>  
            <button class="btn" onclick="authAction('signup')" style="flex:1; color: var(--neon-blue);"><i class="fas fa-user-plus"></i> INIT</button>  
        </div>  
        <p onclick="resetPass()" style="margin-top:15px; font-size:0.7rem; cursor:pointer; text-decoration:underline; opacity: 0.6; color: #aaa;">LOST CREDENTIALS?</p>
    </div>  
</div>  

<!-- MODAL SYSTEM (Generic Reusable) -->
<div id="modal-overlay" tabindex="-1">
    <div class="modal-box" id="modal-box" role="dialog" aria-modal="true">
        <div class="modal-header" id="modal-title">TITLE</div>
        <div class="modal-body" id="modal-body">Content</div>
        <div class="modal-actions" id="modal-actions">
            <!-- Buttons injected by JS -->
        </div>
    </div>
</div>

<!-- APP LAYER -->
<div id="app-layer">  
    <header>  
        <div style="display: flex; align-items: center; gap: 15px;">  
            <button class="btn" onclick="toggleSidebar()" id="menu-btn" style="display:none;">â‰¡</button>  
            <div style="font-weight:600;"><i class="fas fa-terminal"></i> DB NOTEPAD v5.1</div>  
        </div>  
        <div style="display:flex; align-items:center;">  
            <!-- Toolbar -->
            <button class="btn btn-info" onclick="toggleMarkdown()" title="Split Preview"><i class="fas fa-columns"></i> MD</button>
            <button class="btn" onclick="openSettings()" title="Themes & Settings"><i class="fas fa-cog"></i></button>
            <button class="btn" onclick="openExportMenu()" title="Export"><i class="fas fa-file-export"></i></button>
            <button class="btn" onclick="showShortcuts()" title="Keyboard Shortcuts (Ctrl+/)"><i class="fas fa-keyboard"></i></button>
            
            <span style="width:1px; height:20px; background:#333; margin:0 10px;"></span>
            
            <button class="btn" onclick="createNewNote()" title="New (Ctrl+N)">+ NEW</button>  
            <button class="btn" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></button>
            <button class="btn btn-danger" onclick="confirmLogout()"><i class="fas fa-power-off"></i></button>  
        </div>  
    </header>  

    <div class="workspace">  
        <aside id="sidebar">  
            <div id="user-display" class="user-info">
                <span>USER: GUEST</span>
                <i class="fas fa-circle" style="color:var(--neon-main); font-size:0.5rem; align-self:center;"></i>
            </div>
            
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="search-bar" class="search-bar" placeholder="SEARCH (Ctrl+F)">
            </div>
            
            <div class="tag-cloud" id="tag-cloud">
                <!-- Tags generated via JS -->
            </div>

            <div style="padding:5px 15px; font-size:0.6rem; border-bottom:1px solid #222;" id="status-line">STATUS: CHECKING...</div>  
            
            <div class="notes-list" id="notes-list"></div>  
        </aside>  
        
        <main>  
            <div class="editor-toolbar">
                <button class="btn" onclick="togglePin()" title="Pin Note" id="pin-btn" style="border:none;"><i class="far fa-star"></i></button>
                <input type="text" id="doc-title" placeholder="UNTITLED_DOC">  
                <div style="font-size: 0.8rem; color: #555;">
                    <button class="btn" onclick="editorUndo()" title="Undo (Ctrl+Z)"><i class="fas fa-undo"></i></button>
                    <button class="btn" onclick="editorRedo()" title="Redo (Ctrl+Y)"><i class="fas fa-redo"></i></button>
                    <button class="btn" onclick="openVersionHistory()" title="Snapshots"><i class="fas fa-history"></i></button>
                    <button class="btn btn-info" onclick="generateShareLink()" title="Share Link"><i class="fas fa-link"></i></button>
                </div>
            </div>

            <div class="split-view">
                <textarea id="doc-body" placeholder="Start typing... Supports Markdown (# H1, **bold**, - list)"></textarea>  
                <div id="md-preview"></div>
            </div>
            
            <input type="hidden" id="current-id">  
            <input type="hidden" id="is-pinned" value="false">
        </main>  
    </div>  

    <div class="status-bar">  
        <div style="display:flex; gap:15px; align-items:center;">
            <span id="save-indicator">[READY]</span>  
            <span id="word-count" style="color: #666;">WORDS: 0</span>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="btn btn-danger" style="padding: 0 10px; font-size: 0.7rem; height: 20px; display: none;" id="del-btn" onclick="confirmDelete()">DEL</button>
            <span id="clock-display">00:00:00</span>  
        </div>
    </div>  
</div>  

<div id="alert-system"></div>  

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>  
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>  
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>  

<script>  
    // --- PART 1: Viewport Fix (Mobile Address Bar) ---
    function setVh() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    window.addEventListener('resize', setVh);
    setVh();
    
    // --- Firebase Config (Keep original) ---
    const firebaseConfig = {  
        apiKey: "AIzaSyCJDYv3qR88OcpR5Jfm_rMd8z9WZPYqWjw",  
        authDomain: "notepad-c5b98.firebaseapp.com",  
        databaseURL: "https://notepad-c5b98-default-rtdb.firebaseio.com",  
        projectId: "notepad-c5b98",  
        storageBucket: "notepad-c5b98.firebasestorage.app",  
        messagingSenderId: "737040022800",  
        appId: "1:737040022800:web:5e5eb1971ccadf6d753995"  
    };  
    firebase.initializeApp(firebaseConfig);  
    const auth = firebase.auth();  
    const db = firebase.database();  

    let currentUser = null;  
    let autoSaveTimer;  
    let currentTags = new Set();
    let filterTag = null;
    
    class SimpleHistory {
        constructor() { this.stack = []; this.index = -1; this.max = 20; }
        push(state) {
            if (this.index < this.stack.length - 1) {
                this.stack = this.stack.slice(0, this.index + 1);
            }
            this.stack.push(state);
            if (this.stack.length > this.max) this.stack.shift();
            else this.index++;
        }
        undo() { if (this.index > 0) return this.stack[--this.index]; return null; }
        redo() { if (this.index < this.stack.length - 1) return this.stack[++this.index]; return null; }
        current() { return this.stack[this.index]; }
        reset() { this.stack = []; this.index = -1; }
    }
    const noteHistory = new SimpleHistory();

    const CACHE_KEY_PREFIX = 'ghost_cache_';
    const QUEUE_KEY_PREFIX = 'ghost_queue_';

    async function sha256(message) {
        if (!message) return null;
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function logActivity(msg, type = 'info') {
        const container = document.getElementById('alert-system');
        const box = document.createElement('div');
        box.className = `terminal-alert alert-${type}`;
        
        let icon = 'fa-info-circle';
        if(type === 'success') icon = 'fa-check';
        if(type === 'error') icon = 'fa-times-circle';

        const time = new Date().toLocaleTimeString([], { hour12: false });

        box.innerHTML = `
            <div style="display:flex;align-items:center;gap:10px;">
                <i class="fas ${icon}"></i> <span>${msg.toUpperCase()}</span>
            </div>
            <span style="font-size:0.7rem; color:#555">[${time}]</span>
        `;
        
        container.appendChild(box);
        setTimeout(() => {
            box.style.opacity = '0';
            box.style.transform = 'translateX(100%)';
            setTimeout(() => box.remove(), 300);
        }, 3500);
    }

    // --- PART 2 & 3: NEW MODAL SYSTEM (Promise based & Keyboard Friendly) ---
    const SystemUI = {
        overlay: document.getElementById('modal-overlay'),
        box: document.getElementById('modal-box'),
        title: document.getElementById('modal-title'),
        body: document.getElementById('modal-body'),
        actions: document.getElementById('modal-actions'),
        lastFocus: null,
        resolvePromise: null,

        reset: function() {
            this.overlay.style.display = 'none';
            this.title.innerHTML = '';
            this.body.innerHTML = '';
            this.actions.innerHTML = '';
            this.resolvePromise = null;
            if(this.lastFocus) this.lastFocus.focus();
        },

        show: function(title, contentHtml, buttonsHtml = null) {
            this.lastFocus = document.activeElement;
            this.title.innerHTML = title;
            this.body.innerHTML = contentHtml;
            
            // Default close button if no actions provided
            if(!buttonsHtml) {
                this.actions.innerHTML = `<button class="btn" onclick="SystemUI.close()">CLOSE</button>`;
            } else {
                this.actions.innerHTML = buttonsHtml;
            }

            this.overlay.style.display = 'flex';
            
            // Focus Trap Logic
            const focusables = this.box.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if(focusables.length > 0) {
                // Focus the first input or the primary action (usually the first button)
                const input = this.box.querySelector('input');
                if(input) input.focus();
                else focusables[0].focus();
            }
        },

        close: function() {
            if(this.resolvePromise) this.resolvePromise(null); // Resolve with null on generic close
            this.reset();
        },

        // Replaces window.confirm
        confirm: function(title, msg, danger = false) {
            return new Promise((resolve) => {
                const btnClass = danger ? 'btn-danger' : 'btn';
                const html = `
                    <button class="btn ${btnClass}" id="sys-confirm-btn">CONFIRM</button>
                    <button class="btn" onclick="SystemUI.close()">CANCEL</button>
                `;
                this.show(title, `<p>${msg}</p>`, html);
                
                const confirmBtn = document.getElementById('sys-confirm-btn');
                confirmBtn.onclick = () => {
                    resolve(true);
                    this.reset();
                };
                
                // Hook resolve to close for "False"
                this.resolvePromise = (val) => { if(val === null) resolve(false); };
                
                confirmBtn.focus();
            });
        },

        // Replaces window.prompt
        prompt: function(title, msg, type = 'text') {
            return new Promise((resolve) => {
                const html = `
                    <p>${msg}</p>
                    <input type="${type}" id="sys-prompt-input" class="modal-input" autocomplete="off">
                `;
                const btns = `
                    <button class="btn" id="sys-prompt-ok">OK</button>
                    <button class="btn" onclick="SystemUI.close()">CANCEL</button>
                `;
                
                this.show(title, html, btns);
                
                const input = document.getElementById('sys-prompt-input');
                const okBtn = document.getElementById('sys-prompt-ok');
                
                const submit = () => {
                    resolve(input.value);
                    this.reset();
                };
                
                okBtn.onclick = submit;
                input.onkeydown = (e) => { if(e.key === 'Enter') submit(); };
                
                // Hook resolve to close
                this.resolvePromise = (val) => { if(val === null) resolve(null); };
                
                input.focus();
            });
        }
    };

    // Global Key Listener for Modal Interaction (Enter, Escape, Tab Trap)
    document.getElementById('modal-overlay').addEventListener('keydown', (e) => {
        const overlay = document.getElementById('modal-overlay');
        if(overlay.style.display === 'none') return;

        if (e.key === 'Escape') {
            SystemUI.close();
            e.preventDefault();
        }
        
        // Tab Trap
        if (e.key === 'Tab') {
            const focusables = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const first = focusables[0];
            const last = focusables[focusables.length - 1];

            if (e.shiftKey) {
                if (document.activeElement === first) { last.focus(); e.preventDefault(); }
            } else {
                if (document.activeElement === last) { first.focus(); e.preventDefault(); }
            }
        }
    });

    // Helper for legacy code calling showCustomModal
    function showCustomModal(title, html, buttons = null) {
        SystemUI.show(title, html, buttons);
    }
    function closeModal() { SystemUI.close(); }


    // --- AUTH LOGIC ---
    function authAction(type) {  
        const e = document.getElementById('email').value;  
        const p = document.getElementById('pass').value;  
        if(!e || !p) return logActivity("MISSING CREDENTIALS", "error");  

        if(type === 'login') {  
            auth.signInWithEmailAndPassword(e, p)
                .then(() => logActivity("ACCESS GRANTED", "success"))
                .catch(err => logActivity(err.message, "error"));  
        } else {  
            auth.createUserWithEmailAndPassword(e, p)
                .then(() => logActivity("NEW USER INITIALIZED", "success"))
                .catch(err => logActivity(err.message, "error"));  
        }  
    } 

    function resetPass() {
        const e = document.getElementById('email').value;
        if(!e) return logActivity("ENTER EMAIL FOR RECOVERY", 'error');
        auth.sendPasswordResetEmail(e).then(() => logActivity("RECOVERY PROTOCOL SENT", 'info'));
    }

    async function confirmLogout() {
        const yes = await SystemUI.confirm("TERMINATE SESSION?", "Unsaved local changes are preserved but sync will stop.", true);
        if(yes) {
            auth.signOut();
            logActivity('LOGGED OUT','error');
        }
    }

    auth.onAuthStateChanged(user => {  
        const authLayer = document.getElementById('auth-layer');  
        const appLayer = document.getElementById('app-layer');  
        if (user) {  
            currentUser = user.uid;  
            authLayer.style.display = 'none';  
            appLayer.style.display = 'flex';  
            document.getElementById('user-display').innerHTML = `<span>OP: ${user.email.split('@')[0].toUpperCase()}</span> <i class="fas fa-wifi"></i>`;
            loadNotes();  
            checkConnection();
        } else {  
            authLayer.style.display = 'flex';  
            appLayer.style.display = 'none';  
            currentUser = null;
        }  
    });  

    // --- DATA LOGIC ---
    function getLocalCache() { return JSON.parse(localStorage.getItem(CACHE_KEY_PREFIX + currentUser)) || {}; }
    function setLocalCache(data) { localStorage.setItem(CACHE_KEY_PREFIX + currentUser, JSON.stringify(data)); }
    function getOfflineQueue() { return JSON.parse(localStorage.getItem(QUEUE_KEY_PREFIX + currentUser)) || {}; }
    function addToOfflineQueue(id, data) {
        const queue = getOfflineQueue();
        queue[id] = data;
        localStorage.setItem(QUEUE_KEY_PREFIX + currentUser, JSON.stringify(queue));
    }
    function removeFromOfflineQueue(id) {
        const queue = getOfflineQueue();
        delete queue[id];
        localStorage.setItem(QUEUE_KEY_PREFIX + currentUser, JSON.stringify(queue));
    }

    function renderNoteList(data) {
        const list = document.getElementById('notes-list');  
        const activeId = document.getElementById('current-id').value;
        list.innerHTML = '';  
        
        let allTags = new Set();
        let notesArr = [];

        if (data) {  
            Object.entries(data).forEach(([id, note]) => {  
                if (!note) return;
                notesArr.push({id, ...note});
                
                if (!note.lockHash) {
                    const tags = (note.text || '').match(/#[a-z0-9_]+/gi);
                    if(tags) tags.forEach(t => allTags.add(t.toLowerCase()));
                }
            });
            
            notesArr.sort((a, b) => {
                if (a.pinned === b.pinned) return (b.timestamp || 0) - (a.timestamp || 0);
                return a.pinned ? -1 : 1;
            });

            renderTags(allTags);

            notesArr.forEach(note => {
                const noteText = (note.text || '').toLowerCase();
                if(filterTag && !note.lockHash && !noteText.includes(filterTag)) return;
                
                const div = document.createElement('div');  
                div.className = 'note-item' + (note.id === activeId ? ' active' : '') + (note.pinned ? ' pinned' : '');  
                
                const isDirty = getOfflineQueue()[note.id] ? ' <span style="color:var(--neon-yellow)">*</span>' : '';
                const isLocked = note.lockHash ? ' <span style="color:var(--neon-red)">[LOCKED]</span>' : '';

                div.innerHTML = `
                    <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                        <i class="fas fa-file-alt" style="font-size:0.7rem; margin-right:8px; opacity:0.5;"></i> 
                        ${(note.title || 'UNTITLED') + isDirty + isLocked}
                    </div>
                    <i class="fas fa-star pin-icon"></i>
                `;  
                div.onclick = () => loadNoteIntoEditor(note.id, note);  
                list.appendChild(div);  
            });  
        }
        if(notesArr.length === 0) list.innerHTML = '<div style="padding:20px; text-align:center; color:#444;">NO DATA FOUND</div>';
    }

    function renderTags(tags) {
        const cloud = document.getElementById('tag-cloud');
        cloud.innerHTML = '';
        if(tags.size === 0) { cloud.style.display = 'none'; return; }
        cloud.style.display = 'flex';
        
        const allBtn = document.createElement('span');
        allBtn.className = `tag-pill ${!filterTag ? 'active' : ''}`;
        allBtn.innerText = "ALL";
        allBtn.onclick = () => { filterTag = null; loadNotes(); };
        cloud.appendChild(allBtn);

        tags.forEach(tag => {
            const pill = document.createElement('span');
            pill.className = `tag-pill ${filterTag === tag ? 'active' : ''}`;
            pill.innerText = tag;
            pill.onclick = () => { filterTag = tag; loadNotes(); };
            cloud.appendChild(pill);
        });
    }

    function loadNotes() {  
        const localData = getLocalCache();
        renderNoteList(localData);

        db.ref(`notes/${currentUser}`).on('value', snap => {  
            const serverData = snap.val() || {};
            const currentQueue = getOfflineQueue();
            const mergedData = { ...serverData };
            Object.keys(currentQueue).forEach(qid => mergedData[qid] = currentQueue[qid]);
            setLocalCache(mergedData);
            renderNoteList(mergedData);
        });
        if(navigator.onLine) processOfflineQueue();
    }  

    // --- REFACTORED: Load with Async Modal Password ---
    async function loadNoteIntoEditor(id, note) {
        if (note.lockHash) {
            const password = await SystemUI.prompt("SECURE NOTE", "ENTER DECRYPTION KEY:", "password");
            if (!password) return; // Cancelled
            const inputHash = await sha256(password);
            
            if (inputHash !== note.lockHash) {
                logActivity("ACCESS DENIED", "error");
                return;
            }
            logActivity("DECRYPTION SUCCESSFUL", "success");
        }

        document.getElementById('current-id').value = id;  
        document.getElementById('doc-title').value = note.title || '';  
        document.getElementById('doc-body').value = note.text || '';  
        
        const isPinned = note.pinned || false;
        document.getElementById('is-pinned').value = isPinned;
        updatePinBtnUI(isPinned);

        document.getElementById('del-btn').style.display = 'inline-block';
        updateWordCount(); 
        
        if(document.getElementById('md-preview').classList.contains('active')) {
            document.getElementById('md-preview').innerHTML = marked.parse(note.text || '');
        }

        noteHistory.reset();
        noteHistory.push(note.text || '');

        document.querySelectorAll('.note-item').forEach(i => i.classList.remove('active'));
        renderNoteList(getLocalCache());
        
        if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
    }

    function saveNote(silent = false) {  
        if (!currentUser) return;  
        
        let id = document.getElementById('current-id').value;  
        const isNew = !id;
        
        if (isNew) {
            id = navigator.onLine ? db.ref(`notes/${currentUser}`).push().key : `temp_${Date.now()}`;
            document.getElementById('current-id').value = id;
            document.getElementById('del-btn').style.display = 'inline-block';
        }

        const title = document.getElementById('doc-title').value;  
        const text = document.getElementById('doc-body').value;  
        const pinned = document.getElementById('is-pinned').value === 'true';

        const cache = getLocalCache();
        const existingNote = cache[id] || {};
        const lockHash = existingNote.lockHash || null;

        const payload = { title, text, pinned, timestamp: Date.now() };  
        if (lockHash) payload.lockHash = lockHash;

        cache[id] = payload;
        setLocalCache(cache);
        renderNoteList(cache); 

        if(noteHistory.current() !== text) noteHistory.push(text);

        if (navigator.onLine) {
            document.getElementById('save-indicator').innerText = "[SYNCING...]";
            const ref = db.ref(`notes/${currentUser}/${id}`);
            const updatePromise = (isNew || id.startsWith('temp_')) ? ref.set(payload) : ref.update(payload);

            updatePromise.then(() => {
                document.getElementById('save-indicator').innerText = "[SAVED]";
                if(!silent) logActivity("DATA SECURE & SYNCED", "success");
            }).catch(err => {
                addToOfflineQueue(id, payload);
                document.getElementById('save-indicator').innerText = "[QUEUED]";
                logActivity("NET ERROR: QUEUED", "error");
            });
        } else {
            addToOfflineQueue(id, payload);
            document.getElementById('save-indicator').innerText = "[LOCAL]";
            if(!silent) logActivity("OFFLINE SAVE", "info");
        }
    } 

    // --- REFACTORED: Delete with Async Modal ---
    async function confirmDelete() {
        const id = document.getElementById('current-id').value;
        if(!id) return;
        
        const yes = await SystemUI.confirm("DELETE FILE?", "This action is permanent and cannot be undone.", true);
        if(yes) {
            executeDelete(id);
        }
    }

    function executeDelete(id) {
        const cache = getLocalCache();
        delete cache[id]; setLocalCache(cache);
        
        const queue = getOfflineQueue();
        if(queue[id]) { delete queue[id]; removeFromOfflineQueue(id); }

        if(navigator.onLine && !id.startsWith('temp_')) {
            db.ref(`notes/${currentUser}/${id}`).remove();
        }
        createNewNote();
        renderNoteList(cache);
        logActivity("FILE PURGED", "error");
    }

    function processOfflineQueue() {
        const queue = getOfflineQueue();
        Object.keys(queue).forEach(localId => {
            const data = queue[localId];
            if (localId.startsWith('temp_')) {
                const newRef = db.ref(`notes/${currentUser}`).push();
                newRef.set(data).then(() => {
                    const cache = getLocalCache();
                    delete cache[localId]; cache[newRef.key] = data; 
                    setLocalCache(cache);
                    removeFromOfflineQueue(localId); 
                    if (document.getElementById('current-id').value === localId) document.getElementById('current-id').value = newRef.key;
                    renderNoteList(cache);
                });
            } else {
                db.ref(`notes/${currentUser}/${localId}`).update(data).then(() => removeFromOfflineQueue(localId));
            }
        });
    }

    function checkConnection() {
        const statusDiv = document.getElementById('status-line');
        if (navigator.onLine) {
            statusDiv.innerText = "STATUS: ONLINE [SECURE]";
            statusDiv.style.color = "var(--neon-main)";
            processOfflineQueue();
        } else {
            statusDiv.innerText = "STATUS: OFFLINE MODE";
            statusDiv.style.color = "var(--neon-red)";
        }
    }

    window.addEventListener('online', checkConnection);
    window.addEventListener('offline', checkConnection);

    // --- EDITOR FEATURES ---
    function toggleMarkdown() {
        const preview = document.getElementById('md-preview');
        const editor = document.getElementById('doc-body');
        const isActive = preview.classList.toggle('active');
        
        if(isActive) {
            preview.innerHTML = marked.parse(editor.value);
            if(window.innerWidth > 768) editor.style.width = '50%';
        } else {
            editor.style.width = '100%';
        }
    }

    function togglePin() {
        const el = document.getElementById('is-pinned');
        const newState = !(el.value === 'true');
        el.value = newState;
        updatePinBtnUI(newState);
        saveNote(true);
    }
    
    function updatePinBtnUI(isPinned) {
        const btn = document.getElementById('pin-btn');
        if(isPinned) {
            btn.innerHTML = '<i class="fas fa-star"></i>';
            btn.style.color = 'var(--neon-yellow)';
        } else {
            btn.innerHTML = '<i class="far fa-star"></i>';
            btn.style.color = 'var(--neon-main)';
        }
    }

    function editorUndo() {
        const prev = noteHistory.undo();
        if(prev !== null) {
            document.getElementById('doc-body').value = prev;
            updateWordCount();
        }
    }
    function editorRedo() {
        const next = noteHistory.redo();
        if(next !== null) {
            document.getElementById('doc-body').value = next;
            updateWordCount();
        }
    }

    function openVersionHistory() {
        const id = document.getElementById('current-id').value;
        if(!id) return logActivity("SAVE FILE FIRST", "error");

        SystemUI.show("SNAPSHOT MANAGER", 
        `<p>Create a manual restore point for this session?</p>
         <div id="snapshot-list" style="font-size:0.8rem; color:#888; margin-top:15px; max-height:200px; overflow-y:auto;">Fetching...</div>`,
         `<button class="btn btn-info" onclick="createSnapshot('${id}')">CREATE SNAPSHOT</button> <button class="btn" onclick="SystemUI.close()">CLOSE</button>`);
         
         loadSnapshots(id);
    }

    function createSnapshot(id) {
        const text = document.getElementById('doc-body').value;
        const ts = Date.now();
        const snapData = { text, ts };
        
        db.ref(`snapshots/${currentUser}/${id}`).push(snapData).then(() => {
            logActivity("SNAPSHOT SAVED", "success");
            loadSnapshots(id);
        });
    }

    function loadSnapshots(id) {
        db.ref(`snapshots/${currentUser}/${id}`).limitToLast(5).once('value', snap => {
            const list = document.getElementById('snapshot-list');
            list.innerHTML = '';
            if(!snap.exists()) { list.innerHTML = "No snapshots found."; return; }
            
            snap.forEach(child => {
                const val = child.val();
                const date = new Date(val.ts).toLocaleString();
                // Escape simple quotes for the onclick handler
                const safeText = (val.text || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                list.innerHTML += `<div style="padding:5px; border-bottom:1px dashed #333; display:flex; justify-content:space-between;">
                    <span>${date}</span>
                    <button class="btn" style="padding:2px 5px;" onclick="restoreSnapshot('${safeText}')">LOAD</button>
                </div>`;
            });
        });
    }

    window.restoreSnapshot = (text) => {
        document.getElementById('doc-body').value = text;
        updateWordCount();
        saveNote();
        SystemUI.close();
        logActivity("VERSION RESTORED", "info");
    };

    function openSettings() {
        const themes = [
            { name: 'MATRIX', main: '#0f0', bg: '#020202' },
            { name: 'RETRO AMBER', main: '#ffb000', bg: '#1a1000' },
            { name: 'CYBERPUNK', main: '#00f3ff', bg: '#050a14' },
            { name: 'CRIMSON', main: '#ff003c', bg: '#110000' },
            { name: 'ICE', main: '#ffffff', bg: '#000000' }
        ];

        let html = '<div class="theme-grid">';
        themes.forEach(t => {
            html += `<div class="theme-opt" style="color:${t.main}; background:${t.bg}" onclick="setTheme('${t.main}', '${t.bg}')">${t.name}</div>`;
        });
        html += '</div>';

        SystemUI.show("SYSTEM CONFIGURATION", html);
    }

    function setTheme(main, bg) {
        document.documentElement.style.setProperty('--neon-main', main);
        document.documentElement.style.setProperty('--bg-deep', bg);
        SystemUI.close();
    }

    function openExportMenu() {
        const html = `
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn" onclick="exportDoc('txt')">DOWNLOAD .TXT</button>
                <button class="btn" onclick="exportDoc('md')">DOWNLOAD .MD</button>
                <button class="btn" onclick="exportDoc('pdf')">EXPORT PDF</button>
                <button class="btn" onclick="exportDoc('email')">SEND VIA EMAIL</button>
            </div>
        `;
        SystemUI.show("EXPORT DATA", html);
    }

    function exportDoc(type) {
        const title = document.getElementById('doc-title').value || 'untitled';
        const text = document.getElementById('doc-body').value;
        
        if(type === 'email') {
            window.location.href = `mailto:?subject=${title}&body=${encodeURIComponent(text)}`;
        } else if (type === 'pdf') {
            const element = document.createElement('div');
            element.innerHTML = `<h1>${title}</h1>` + marked.parse(text);
            html2pdf().from(element).save(title + '.pdf');
        } else {
            const blob = new Blob([text], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${title}.${type}`;
            a.click();
        }
        SystemUI.close();
    }

    function generateShareLink() {
        const id = document.getElementById('current-id').value;
        if(!id || id.startsWith('temp_')) return logActivity("SYNC FILE BEFORE SHARING", "error");
        
        const link = `${window.location.origin}${window.location.pathname}?share=${id}&user=${currentUser}`;
        
        navigator.clipboard.writeText(link).then(() => {
            logActivity("LINK COPIED TO CLIPBOARD", "success");
            SystemUI.show("SHARE LINK GENERATED", `<input type="text" value="${link}" style="width:100%; background:black; color:white; border:1px solid #333; padding:10px;"> <p style="font-size:0.7rem; color:#666; margin-top:5px;">Note: Requires database rules to allow public read access.</p>`);
        });
    }

    // --- PART 4: KEYBOARD SHORTCUTS PANEL ---
    function showShortcuts() {
        const shortcuts = [
            { cat: "FILE OPERATIONS", key: "Ctrl + N", desc: "New Note" },
            { cat: "", key: "Ctrl + Shift + N", desc: "Duplicate Note" },
            { cat: "", key: "Ctrl + S", desc: "Save Note" },
            { cat: "", key: "Ctrl + D", desc: "Delete Note" },
            { cat: "", key: "Ctrl + Shift + D", desc: "Delete All Notes" },
            
            { cat: "SECURITY", key: "Ctrl + L", desc: "Lock/Unlock Note" },
            { cat: "", key: "Ctrl + Shift + L", desc: "Change Password" },
            { cat: "", key: "Ctrl + B", desc: "Toggle Read-Only" },
            
            { cat: "EDITING", key: "Ctrl + Z / Y", desc: "Undo / Redo" },
            { cat: "", key: "Ctrl + Shift + T", desc: "Insert Timestamp" },
            { cat: "", key: "Ctrl + Shift + U", desc: "To Uppercase" },
            
            { cat: "NAVIGATION", key: "Ctrl + 1 / 2 / 3", desc: "Focus Title / Body / Search" },
            { cat: "", key: "Ctrl + F", desc: "Search Notes" },
            { cat: "", key: "Alt + Arrows", desc: "Navigate List" },
            { cat: "", key: "Ctrl + /", desc: "Show Shortcuts" },
        ];

        let html = `<table class="shortcut-table">`;
        shortcuts.forEach(s => {
            if(s.cat) html += `<tr><td colspan="2" class="shortcut-cat">${s.cat}</td></tr>`;
            html += `<tr><td class="key">${s.key}</td><td class="desc">${s.desc}</td></tr>`;
        });
        html += `</table>`;

        SystemUI.show("KEYBOARD CONTROLS", html);
    }

    const urlParams = new URLSearchParams(window.location.search);
    const shareId = urlParams.get('share');
    const shareUser = urlParams.get('user');

    if(shareId && shareUser) {
        document.getElementById('auth-layer').style.display = 'none';
        document.getElementById('app-layer').style.display = 'flex';
        document.querySelector('header').style.display = 'none'; 
        document.getElementById('sidebar').style.display = 'none';
        document.getElementById('doc-body').setAttribute('readonly', true);
        document.getElementById('doc-title').setAttribute('readonly', true);
        
        db.ref(`notes/${shareUser}/${shareId}`).once('value').then(snap => {
            if(snap.exists()) {
                const val = snap.val();
                document.getElementById('doc-title').value = val.title;
                document.getElementById('doc-body').value = val.text;
                toggleMarkdown();
            } else {
                alert("Shared note not found or access denied.");
            }
        });
    }

    function triggerSave() {  
        document.getElementById('save-indicator').innerText = "[TYPING...]";  
        updateWordCount();
        
        if(document.getElementById('md-preview').classList.contains('active')) {
             document.getElementById('md-preview').innerHTML = marked.parse(document.getElementById('doc-body').value);
        }

        clearTimeout(autoSaveTimer);  
        autoSaveTimer = setTimeout(() => saveNote(true), 2000); 
    }  

    document.getElementById('doc-title').oninput = triggerSave;  
    document.getElementById('doc-body').oninput = triggerSave;  
    
    document.getElementById('search-bar').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.note-item').forEach(item => {
            item.style.display = item.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
        });
    });

    function createNewNote() {  
        document.getElementById('current-id').value = '';  
        document.getElementById('doc-title').value = '';  
        document.getElementById('doc-body').value = '';  
        document.getElementById('is-pinned').value = 'false';
        updatePinBtnUI(false);
        document.getElementById('del-btn').style.display = 'none';
        document.querySelectorAll('.note-item').forEach(i => i.classList.remove('active'));
        updateWordCount();
        document.getElementById('doc-title').focus(); 
        logActivity("NEW WORKSPACE", "info"); 
    }  
    
    function updateWordCount() {
        const text = document.getElementById('doc-body').value;
        const count = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
        document.getElementById('word-count').innerText = `WORDS: ${count}`;
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }  
    function toggleFullScreen() {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen();
        else if (document.exitFullscreen) document.exitFullscreen();
    }
    
    // --- REFACTORED: Advanced Features with Async Modals ---

    async function toggleLock() {
        const id = document.getElementById('current-id').value;
        if(!id) return logActivity("SELECT A NOTE TO LOCK", "error");

        const cache = getLocalCache();
        const note = cache[id];
        
        if(note.lockHash) {
            const pass = await SystemUI.prompt("UNLOCK NOTE", "ENTER CURRENT PASSWORD", "password");
            if(!pass) return;
            const hash = await sha256(pass);
            if(hash === note.lockHash) {
                delete cache[id].lockHash;
                setLocalCache(cache);
                saveNote();
                logActivity("SECURITY REMOVED", "info");
                renderNoteList(cache);
            } else {
                logActivity("INCORRECT PASSWORD", "error");
            }
        } else {
            const pass = await SystemUI.prompt("SECURE NOTE", "SET NEW PASSWORD", "password");
            if(!pass) return;
            const hash = await sha256(pass);
            cache[id].lockHash = hash;
            setLocalCache(cache);
            saveNote();
            logActivity("NOTE SECURED", "success");
            renderNoteList(cache);
        }
    }

    async function changePassword() {
        const id = document.getElementById('current-id').value;
        if(!id) return;
        const cache = getLocalCache();
        const note = cache[id];
        
        if(!note.lockHash) return logActivity("NOTE IS NOT LOCKED", "error");

        const oldPass = await SystemUI.prompt("VERIFY CREDENTIALS", "ENTER OLD PASSWORD", "password");
        if(!oldPass) return;
        
        const oldHash = await sha256(oldPass);
        if(oldHash !== note.lockHash) return logActivity("INVALID PASSWORD", "error");

        const newPass = await SystemUI.prompt("UPDATE CREDENTIALS", "ENTER NEW PASSWORD", "password");
        if(newPass) {
            const newHash = await sha256(newPass);
            cache[id].lockHash = newHash;
            setLocalCache(cache);
            saveNote();
            logActivity("CREDENTIALS UPDATED", "success");
        }
    }

    function duplicateNote() {
        const title = document.getElementById('doc-title').value + " (COPY)";
        const text = document.getElementById('doc-body').value;
        if(!text) return;

        createNewNote();
        document.getElementById('doc-title').value = title;
        document.getElementById('doc-body').value = text;
        saveNote();
        logActivity("NOTE DUPLICATED", "info");
    }

    async function deleteAllNotes() {
        const yes = await SystemUI.confirm("DANGER ZONE", "DELETE ALL NOTES? THIS CANNOT BE UNDONE.", true);
        if(!yes) return;
        
        const cache = getLocalCache();
        Object.keys(cache).forEach(id => {
            if(!id.startsWith('temp_')) db.ref(`notes/${currentUser}/${id}`).remove();
        });
        setLocalCache({});
        localStorage.removeItem(QUEUE_KEY_PREFIX + currentUser);
        createNewNote();
        renderNoteList({});
        logActivity("DATABASE FLUSHED", "error");
    }

    function toggleReadOnly() {
        const body = document.getElementById('doc-body');
        const isRO = body.hasAttribute('readonly');
        if(isRO) {
            body.removeAttribute('readonly');
            logActivity("EDIT MODE ENABLED", "info");
        } else {
            body.setAttribute('readonly', true);
            logActivity("READ-ONLY ENABLED", "info");
        }
    }

    function manipulateText(type) {
        const ta = document.getElementById('doc-body');
        const start = ta.selectionStart;
        const end = ta.selectionEnd;
        let text = ta.value;
        const sel = text.substring(start, end);

        if(type === 'upper') {
            ta.value = text.substring(0, start) + sel.toUpperCase() + text.substring(end);
        } else if(type === 'lower') {
            ta.value = text.substring(0, start) + sel.toLowerCase() + text.substring(end);
        } else if(type === 'timestamp') {
            ta.value = text.substring(0, start) + new Date().toLocaleString() + text.substring(end);
        }
        
        ta.setSelectionRange(start, end); // restore selection
        triggerSave();
    }

    // --- MASTER KEYBOARD CONTROLLER ---

    document.addEventListener('keydown', async (e) => {
        // Prevent default shortcut conflicts if modal is open
        if(document.getElementById('modal-overlay').style.display === 'flex') return;

        // Global Shortcuts
        if (e.ctrlKey || e.altKey) {
            
            // File Operations
            if (e.ctrlKey && e.key.toLowerCase() === 's') {
                e.preventDefault();
                if(e.shiftKey) { saveNote(); } 
                else { saveNote(false); }
            }
            if (e.ctrlKey && e.key.toLowerCase() === 'n') {
                e.preventDefault();
                e.shiftKey ? duplicateNote() : createNewNote();
            }
            if (e.ctrlKey && e.key.toLowerCase() === 'd') {
                e.preventDefault();
                e.shiftKey ? deleteAllNotes() : confirmDelete();
            }
            if (e.ctrlKey && e.key.toLowerCase() === 'p') {
                e.preventDefault();
                togglePin();
            }

            // Security
            if (e.ctrlKey && e.key.toLowerCase() === 'l') {
                e.preventDefault();
                e.shiftKey ? changePassword() : toggleLock();
            }
            if (e.ctrlKey && e.key.toLowerCase() === 'b') {
                e.preventDefault();
                toggleReadOnly();
            }

            // Navigation
            if (e.altKey && (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'Home' || e.key === 'End' || e.key === 'PageUp' || e.key === 'PageDown')) {
                e.preventDefault();
                const items = Array.from(document.querySelectorAll('.note-item'));
                if(items.length === 0) return;
                
                let activeIdx = items.findIndex(el => el.classList.contains('active'));
                let targetIdx = activeIdx;

                if (e.key === 'ArrowUp' || e.key === 'PageUp') targetIdx = activeIdx - 1;
                if (e.key === 'ArrowDown' || e.key === 'PageDown') targetIdx = activeIdx + 1;
                if (e.key === 'Home') targetIdx = 0;
                if (e.key === 'End') targetIdx = items.length - 1;

                if(targetIdx < 0) targetIdx = 0;
                if(targetIdx >= items.length) targetIdx = items.length - 1;
                
                items[targetIdx].click();
                items[targetIdx].scrollIntoView({block: 'center'});
            }

            // Focus
            if (e.ctrlKey && e.key === '1') { e.preventDefault(); document.getElementById('doc-title').focus(); }
            if (e.ctrlKey && e.key === '2') { e.preventDefault(); document.getElementById('doc-body').focus(); }
            if (e.ctrlKey && e.key === '3') { e.preventDefault(); document.getElementById('search-bar').focus(); }

            // Search
            if (e.ctrlKey && e.key.toLowerCase() === 'f') {
                e.preventDefault();
                if(e.shiftKey) { document.getElementById('search-bar').value = ''; loadNotes(); }
                document.getElementById('search-bar').focus();
            }

            // History
            if (e.ctrlKey && e.key.toLowerCase() === 'z') {
                e.preventDefault();
                if(e.shiftKey) editorRedo(); else editorUndo();
            }
            if (e.ctrlKey && e.key.toLowerCase() === 'y') { e.preventDefault(); editorRedo(); }
            
            // Show Shortcuts
            if (e.ctrlKey && e.key === '/') {
                e.preventDefault();
                showShortcuts();
            }

            // Content Manipulation
            if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); saveNote(false); }
            if (e.ctrlKey && e.key === 'Backspace') {
                if(document.activeElement === document.getElementById('doc-body')) {
                    const confirmClear = await SystemUI.confirm("CLEAR WORKSPACE?", "This will wipe the current text editor.", true);
                    if(confirmClear) {
                        document.getElementById('doc-body').value = '';
                        triggerSave();
                    }
                }
            }
            if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'c') {
                e.preventDefault();
                const confirmWipe = await SystemUI.confirm("WIPE ALL FIELDS?", "Clear title and body?", true);
                if(confirmWipe) {
                    document.getElementById('doc-body').value = '';
                    document.getElementById('doc-title').value = '';
                    triggerSave();
                }
            }
            if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'u') { e.preventDefault(); manipulateText('upper'); }
            if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'o') { e.preventDefault(); manipulateText('lower'); }
            if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 't') { e.preventDefault(); manipulateText('timestamp'); }

            // Scrolling
            if (e.ctrlKey && (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
                const body = document.getElementById('doc-body');
                if (document.activeElement === body) {
                    if (e.key === 'ArrowUp') body.scrollTop -= 20;
                    if (e.key === 'ArrowDown') body.scrollTop += 20;
                    if (e.key === 'ArrowLeft') body.setSelectionRange(0, 0);
                    if (e.key === 'ArrowRight') body.setSelectionRange(body.value.length, body.value.length);
                }
            }
        }

        // Tab Cycling (Simple Trap)
        if (e.key === 'Escape') { document.activeElement.blur(); }
    });

    setInterval(() => { document.getElementById('clock-display').innerText = new Date().toLocaleTimeString(); }, 1000);  

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => {});  
</script>

</body>  
</html>
