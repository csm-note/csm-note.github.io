<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSM Cloud OS | Advanced File Manager</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css"/>
    
    <style>
        :root { --accent: #00ffcc; --bg: #0a0a0a; --card: #161616; --border: #333; --text: #eee; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; user-select: none; }
        
        #loginOverlay { position: fixed; inset: 0; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 5000; }
        .login-card { background: var(--card); padding: 40px; border-radius: 24px; border: 1px solid var(--border); width: 90%; max-width: 400px; text-align: center; }

        #mainContent { display: none; }

        header { padding: 15px 30px; background: #111; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 18px; font-weight: 800; color: var(--accent); letter-spacing: 1px; }

        .manager-tools { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .search-box { width: 100%; padding: 12px 20px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; color: white; margin-bottom: 20px; outline: none; }

        .tab-bar { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab { padding: 10px 25px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; white-space: nowrap; font-size: 14px; font-weight: 600; color: #888; }
        .tab.active { background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(0,255,204,0.3); }

        .upload-area { background: var(--card); padding: 25px; border-radius: 15px; border: 2px dashed var(--border); text-align: center; margin-bottom: 30px; }
        .btn-main { background: var(--accent); color: #000; padding: 12px 30px; border-radius: 10px; cursor: pointer; font-weight: 700; border:none; }
        .input-text { padding: 10px; background: #222; border: 1px solid var(--border); border-radius: 8px; color: white; width: 250px; text-align: center; margin-bottom: 10px; }

        /* Glowing Progress Bar */
        #progressWrap { margin-top: 20px; display: none; }
        .p-bar-bg { width: 100%; height: 8px; background: #222; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        #p-bar-fill { height: 100%; width: 0%; background: var(--accent); box-shadow: 0 0 15px var(--accent); transition: 0.3s; }

        /* File Grid */
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .file-card { background: var(--card); border-radius: 15px; border: 1px solid var(--border); overflow: hidden; position: relative; transition: 0.3s; }
        .file-card:hover { border-color: var(--accent); transform: translateY(-3px); }
        
        .preview-area { height: 140px; background: #111; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; }
        .preview-area img, .preview-area video { width: 100%; height: 100%; object-fit: cover; }
        .file-icon { font-size: 40px; }

        .file-info { padding: 12px; }
        .file-name { font-size: 13px; font-weight: 600; margin-bottom: 5px; color: var(--accent); cursor: pointer; }
        .file-meta { font-size: 11px; color: #666; display: flex; justify-content: space-between; }

        /* Advanced Action Menu */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 10px; background: #1a1a1a; border-top: 1px solid var(--border); }
        .act-btn { padding: 8px; font-size: 10px; font-weight: bold; border-radius: 5px; border: none; background: #333; color: #ccc; cursor: pointer; }
        .act-btn:hover { background: var(--accent); color: #000; }
        .btn-move { background: #254b45; color: var(--accent); }
        .btn-del { background: #4b2525; color: #ff4444; }

        .locked-blur { filter: blur(40px); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2 style="color:var(--accent); margin-bottom:25px;">CSM PRIVATE DRIVE</h2>
        <input type="email" id="loginEmail" class="input-text" style="width:100%" placeholder="Admin Email">
        <input type="password" id="loginPass" class="input-text" style="width:100%" placeholder="Password">
        <button id="doLogin" class="btn-main" style="width:100%">Access Storage</button>
    </div>
</div>

<div id="mainContent">
    <header>
        <div class="logo">CSM DRIVE v2.0</div>
        <button onclick="auth.signOut()" style="background:none; border:none; color:#ff4444; font-weight:bold; cursor:pointer;">Sign Out</button>
    </header>

    <div class="manager-tools">
        <input type="text" id="searchBox" class="search-box" placeholder="Search for files or documents...">

        <div class="tab-bar">
            <div class="tab active" data-cat="image" onclick="setTab('image', this)">üì∏ Images</div>
            <div class="tab" data-cat="video" onclick="setTab('video', this)">üé• Videos</div>
            <div class="tab" data-cat="audio" onclick="setTab('audio', this)">üéµ Audio</div>
            <div class="tab" data-cat="raw" onclick="setTab('raw', this)">üìÅ Documents</div>
        </div>

        <div class="upload-area">
            <input type="text" id="filePass" class="input-text" placeholder="Protection Key (Optional)">
            <br>
            <label for="fileInput" class="btn-main">Select & Upload</label>
            <input type="file" id="fileInput" style="display:none">
            
            <div id="progressWrap">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--accent);">
                    <span id="p-status">Uploading...</span>
                    <span id="p-percent">0%</span>
                </div>
                <div class="p-bar-bg"><div id="p-bar-fill"></div></div>
            </div>
        </div>

        <div class="file-grid" id="fileGrid"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBtmUmV1KxQDB0jN9gUQnh-eYWKllMPav0",
        authDomain: "photos-58c8e.firebaseapp.com",
        projectId: "photos-58c8e",
        storageBucket: "photos-58c8e.firebasestorage.app",
        messagingSenderId: "1014680212942",
        appId: "1:1014680212942:web:2319c936cdcac09dcac79f",
        databaseURL: "https://photos-58c8e-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const galleryRef = ref(db, 'csm_file_manager_v2');

    let activeTab = 'image';
    let allData = [];

    // Auth & Persistence
    document.getElementById('doLogin').onclick = async () => {
        try {
            await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value);
        } catch (err) { alert("Denied!"); }
    };

    onAuthStateChanged(auth, user => {
        document.getElementById('loginOverlay').style.display = user ? 'none' : 'flex';
        document.getElementById('mainContent').style.display = user ? 'block' : 'none';
        if(user) loadFiles();
    });

    window.setTab = (t, el) => {
        activeTab = t;
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        renderFiles();
    };

    function loadFiles() {
        onValue(galleryRef, snap => {
            allData = [];
            const data = snap.val();
            if(data) {
                Object.keys(data).forEach(id => allData.push({id, ...data[id]}));
                allData.reverse();
            }
            renderFiles();
        });
    }

    // --- Core Advanced Functions ---

    window.renameFile = (id, currentName) => {
        const newName = prompt("Enter new filename:", currentName);
        if(newName && newName !== currentName) {
            update(ref(db, `csm_file_manager_v2/${id}`), { name: newName });
        }
    };

    window.moveFile = (id, currentCat) => {
        const categories = ['image', 'video', 'audio', 'raw'];
        const newCat = prompt(`Move to folder? (Choices: ${categories.join(', ')})`, currentCat);
        if(newCat && categories.includes(newCat) && newCat !== currentCat) {
            update(ref(db, `csm_file_manager_v2/${id}`), { cat: newCat });
        }
    };

    window.deleteFile = (id) => {
        if(confirm("Permanently delete this item?")) remove(ref(db, `csm_file_manager_v2/${id}`));
    };

    window.copyLink = (link) => {
        navigator.clipboard.writeText(link).then(() => alert("Direct link copied!"));
    };

    // --- Rendering Engine ---
    function renderFiles(filter = "") {
        const grid = document.getElementById('fileGrid');
        grid.innerHTML = "";
        const searchTerm = document.getElementById('searchBox').value.toLowerCase();
        
        const filtered = allData.filter(item => 
            item.cat === activeTab && 
            (item.name || "").toLowerCase().includes(searchTerm)
        );

        filtered.forEach(file => {
            const card = document.createElement('div');
            card.className = 'file-card';
            const isLocked = !!file.password;

            let previewHtml = `<div class="file-icon">${getIcon(file.cat)}</div>`;
            if(file.cat === 'image') previewHtml = `<img src="${file.url}" class="${isLocked ? 'locked-blur' : ''}" data-fancybox="gallery">`;
            if(file.cat === 'video') previewHtml = `<video src="${file.url}" class="${isLocked ? 'locked-blur' : ''}"></video>`;

            card.innerHTML = `
                <div class="preview-area" onclick="${isLocked ? '' : `window.open('${file.url}')`}">
                    ${previewHtml}
                    ${isLocked ? '<div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center;">üîí</div>' : ''}
                </div>
                <div class="file-info">
                    <div class="file-name" onclick="renameFile('${file.id}', '${file.name}')" title="Click to rename">${file.name || 'Untitled'} ‚úé</div>
                    <div class="file-meta">
                        <span>${file.size || '0 MB'}</span>
                        <span>${new Date(file.timestamp).toLocaleDateString()}</span>
                    </div>
                </div>
                <div class="action-grid">
                    <button class="act-btn" onclick="copyLink('${file.url}')">Link</button>
                    <a href="${file.url}" download class="act-btn" style="text-decoration:none; text-align:center;">Save</a>
                    <button class="act-btn btn-move" onclick="moveFile('${file.id}', '${file.cat}')">Move</button>
                    <button class="act-btn btn-del" onclick="deleteFile('${file.id}')">Delete</button>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function getIcon(cat) {
        if(cat === 'audio') return 'üéµ';
        if(cat === 'raw') return 'üìÑ';
        return 'üìÅ';
    }

    // --- Advanced Upload Handler ---
    document.getElementById('fileInput').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        let cat = 'raw';
        if(file.type.startsWith('image')) cat = 'image';
        else if(file.type.startsWith('video')) cat = 'video';
        else if(file.type.startsWith('audio')) cat = 'audio';

        const wrap = document.getElementById('progressWrap');
        const fill = document.getElementById('p-bar-fill');
        const text = document.getElementById('p-percent');
        wrap.style.display = 'block';

        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", "github_unsigned");

        const xhr = new XMLHttpRequest();
        xhr.open("POST", `https://api.cloudinary.com/v1_1/dx7aankx2/auto/upload`);
        
        xhr.upload.onprogress = ev => {
            const p = Math.round((ev.loaded / ev.total) * 100);
            fill.style.width = p + "%";
            text.innerText = p + "%";
        };

        xhr.onload = () => {
            const res = JSON.parse(xhr.responseText);
            push(galleryRef, {
                url: res.secure_url,
                name: file.name,
                size: (file.size / (1024*1024)).toFixed(2) + " MB",
                cat: cat,
                password: document.getElementById('filePass').value,
                timestamp: Date.now()
            });
            wrap.style.display = 'none';
            document.getElementById('filePass').value = "";
        };
        xhr.send(formData);
    };

    document.getElementById('searchBox').oninput = () => renderFiles();
</script>
</body>
</html>
