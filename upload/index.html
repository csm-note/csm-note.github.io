<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Database Gallery</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body {
            background: #0f0f0f;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            background: #141414;
            border-bottom: 1px solid #222;
            color: #00ffcc;
        }
        .upload-area {
            margin: 20px;
            padding: 40px;
            border: 2px dashed #444;
            border-radius: 15px;
            text-align: center;
            transition: .3s;
            background: #141414;
        }
        .upload-area:hover { border-color: #00ffcc; }
        input[type="file"] { display: none; }
        button.upload-btn {
            padding: 12px 25px;
            background: #00ffcc;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #000;
            margin-top: 10px;
        }
        .progress {
            width: 100%;
            height: 6px;
            background: #222;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: #00ffcc;
            transition: .3s;
        }
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            padding: 20px;
            flex: 1;
        }
        .card {
            position: relative;
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            height: 200px;
        }
        .card img, .card video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 0, 0, 0.8);
            border: none;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

<header>Permanent Cloud Gallery</header>

<div class="upload-area" id="dropArea">
    <p>Drag & Drop Image or Video Here</p>
    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Select File</button>
    <input type="file" id="fileInput" accept="image/*,video/*">
    <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
</div>

<div class="gallery" id="gallery"></div>

<script type="module">
    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ১. আপনার Firebase কনফিগারেশন
    const firebaseConfig = {
        apiKey: "AIzaSyBtmUmV1KxQDB0jN9gUQnh-eYWKllMPav0",
        authDomain: "photos-58c8e.firebaseapp.com",
        projectId: "photos-58c8e",
        storageBucket: "photos-58c8e.firebasestorage.app",
        messagingSenderId: "1014680212942",
        appId: "1:1014680212942:web:2319c936cdcac09dcac79f",
        databaseURL: "https://photos-58c8e-default-rtdb.firebaseio.com" // আপনার Project ID অনুযায়ী অটো-সেট করা
    };

    // Firebase Initialize
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const galleryRef = ref(db, 'my_gallery');

    // Cloudinary কনফিগারেশন
    const cloudName = "dx7aankx2";
    const uploadPreset = "github_unsigned";

    // ২. Database থেকে রিয়েল-টাইমে ডেটা পড়া
    onValue(galleryRef, (snapshot) => {
        const galleryDiv = document.getElementById("gallery");
        galleryDiv.innerHTML = "";
        const data = snapshot.val();
        
        if (data) {
            // অবজেক্টকে অ্যারেতে রূপান্তর করে লেটেস্ট ফাইল আগে দেখাচ্ছি
            Object.keys(data).reverse().forEach(key => {
                const item = data[key];
                const card = document.createElement("div");
                card.className = "card";
                
                // ইমেজ নাকি ভিডিও চেক
                if (item.type === "video") {
                    card.innerHTML = `<video src="${item.url}" controls></video>`;
                } else {
                    card.innerHTML = `<img src="${item.url}" loading="lazy">`;
                }
                
                // ডিলিট বাটন ফাংশনালিটি
                const delBtn = document.createElement("button");
                delBtn.className = "delete";
                delBtn.innerHTML = "×";
                delBtn.onclick = () => {
                    if(confirm("Are you sure you want to delete this file permanently?")) {
                        remove(ref(db, `my_gallery/${key}`));
                    }
                };
                
                card.appendChild(delBtn);
                galleryDiv.appendChild(card);
            });
        }
    });

    // ৩. Cloudinary-তে ফাইল আপলোড এবং Firebase-এ লিঙ্ক সেভ করা
    async function uploadFile(file) {
        if(!file) return;
        const progressBar = document.getElementById("progressBar");
        
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", uploadPreset);

        const xhr = new XMLHttpRequest();
        // 'auto' ব্যবহার করা হয়েছে যাতে ইমেজ/ভিডিও দুটোই আপলোড হয়
        xhr.open("POST", `https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`);

        xhr.upload.onprogress = (e) => {
            if(e.lengthComputable) {
                let percent = (e.loaded / e.total) * 100;
                progressBar.style.width = percent + "%";
            }
        };

        xhr.onload = function() {
            if (xhr.status === 200) {
                const res = JSON.parse(xhr.responseText);
                // Firebase Database-এ পাঠানো হচ্ছে
                push(galleryRef, {
                    url: res.secure_url,
                    type: res.resource_type, // 'image' or 'video'
                    timestamp: Date.now()
                });
            } else {
                alert("Upload failed! Please check your Cloudinary Preset.");
            }
            progressBar.style.width = "0%";
        };

        xhr.onerror = () => alert("Network error. Could not upload.");
        xhr.send(formData);
    }

    // ৪. ইভেন্ট লিসেনারস
    document.getElementById("fileInput").addEventListener("change", function(){
        uploadFile(this.files[0]);
    });

    // ড্র্যাগ অ্যান্ড ড্রপ লজিক
    const dropArea = document.getElementById("dropArea");
    dropArea.addEventListener("dragover", (e) => { 
        e.preventDefault(); 
        dropArea.style.background = "#1f1f1f"; 
    });
    dropArea.addEventListener("dragleave", () => { 
        dropArea.style.background = "#141414"; 
    });
    dropArea.addEventListener("drop", (e) => {
        e.preventDefault();
        dropArea.style.background = "#141414";
        uploadFile(e.dataTransfer.files[0]);
    });

</script>

</body>
</html>
